<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>WebViewJavascriptBridge原理分析 | 个人博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="问题&amp;gt;a.Native（中的UIWebView）是否可以直接调用js method（方法）？可以。&amp;gt;b.js 是否可以直接调用Native的mthod？不行。
JS端调用OC方法12345678callbackButton.onclick = function(e) &amp;#123;	 e.preventDefault()    log(&amp;apos;JS calling handler &amp;">
<meta property="og:type" content="article">
<meta property="og:title" content="WebViewJavascriptBridge原理分析">
<meta property="og:url" content="http://yoursite.com/2016/09/17/WebViewJavascriptBridge原理分析/index.html">
<meta property="og:site_name" content="个人博客">
<meta property="og:description" content="问题&amp;gt;a.Native（中的UIWebView）是否可以直接调用js method（方法）？可以。&amp;gt;b.js 是否可以直接调用Native的mthod？不行。
JS端调用OC方法12345678callbackButton.onclick = function(e) &amp;#123;	 e.preventDefault()    log(&amp;apos;JS calling handler &amp;">
<meta property="og:updated_time" content="2016-09-17T14:48:05.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="WebViewJavascriptBridge原理分析">
<meta name="twitter:description" content="问题&amp;gt;a.Native（中的UIWebView）是否可以直接调用js method（方法）？可以。&amp;gt;b.js 是否可以直接调用Native的mthod？不行。
JS端调用OC方法12345678callbackButton.onclick = function(e) &amp;#123;	 e.preventDefault()    log(&amp;apos;JS calling handler &amp;">
  
    <link rel="alternate" href="/atom.xml" title="个人博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">个人博客</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Zoeken"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-WebViewJavascriptBridge原理分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/09/17/WebViewJavascriptBridge原理分析/" class="article-date">
  <time datetime="2016-09-17T13:59:34.000Z" itemprop="datePublished">2016-09-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      WebViewJavascriptBridge原理分析
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h4><p>&gt;<br>a.Native（中的UIWebView）是否可以直接调用js method（方法）？可以。<br>&gt;<br>b.js 是否可以直接调用Native的mthod？不行。</p>
<h2 id="JS端调用OC方法"><a href="#JS端调用OC方法" class="headerlink" title="JS端调用OC方法"></a>JS端调用OC方法</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">callbackButton.onclick = function(e) &#123;</div><div class="line">	 e.preventDefault()</div><div class="line">    log(&apos;JS calling handler &quot;testObjcCallback&quot;&apos;)</div><div class="line">    //1</div><div class="line">    bridge.callHandler(&apos;testObjcCallback&apos;, &#123;&apos;foo&apos;: &apos;bar&apos;&#125;, function(response) &#123;</div><div class="line">        log(&apos;JS got response&apos;, response)</div><div class="line">    &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>callHandler函数调用_doSend方法，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">function callHandler(handlerName, data, responseCallback) &#123;</div><div class="line">    _doSend(&#123; handlerName:handlerName, data:data &#125;, responseCallback)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">function _doSend(message, responseCallback) &#123;</div><div class="line">    if (responseCallback) &#123;</div><div class="line">        var callbackId = &apos;cb_&apos;+(uniqueId++)+&apos;_&apos;+new Date().getTime()</div><div class="line">        responseCallbacks[callbackId] = responseCallback//将回调函数再JS端保存起来</div><div class="line">        message[&apos;callbackId&apos;] = callbackId</div><div class="line">    &#125;</div><div class="line">    sendMessageQueue.push(message) //在JS部分将message保存在一个数组中</div><div class="line">    messagingIframe.src = CUSTOM_PROTOCOL_SCHEME + &apos;://&apos; + QUEUE_HAS_MESSAGE//如果设置webView中iframe的src，即会触发webView的回调函数</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可见message是个字典，有handlerName,data,callbackId参数(如果有responseCallback的话)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">- (BOOL)webView:(UIWebView *)webView shouldStartLoadWithRequest:(NSURLRequest *)request navigationType:(UIWebViewNavigationType)navigationType &#123;</div><div class="line">    if (webView != _webView) &#123; return YES; &#125;</div><div class="line">    NSURL *url = [request URL];</div><div class="line">    __strong WVJB_WEBVIEW_DELEGATE_TYPE* strongDelegate = _webViewDelegate;</div><div class="line">    if ([_base isCorrectProcotocolScheme:url]) &#123;</div><div class="line">        if ([_base isCorrectHost:url]) &#123;</div><div class="line">            NSString *messageQueueString = [self _evaluateJavascript:[_basewebViewJavascriptFetchQueyCommand]];//调用JS代码获取message数组</div><div class="line">            [_base flushMessageQueue:messageQueueString];</div><div class="line">        &#125; else &#123;</div><div class="line">            [_base logUnkownMessage:url];</div><div class="line">        &#125;</div><div class="line">        return NO;</div><div class="line">    &#125; else if (strongDelegate &amp;&amp; [strongDelegate respondsToSelector:@selector(webView:shouldStartLoadWithRequest:navigationType:)]) &#123;</div><div class="line">        return [strongDelegate webView:webView shouldStartLoadWithRequest:requestnavigationType:navigationType];</div><div class="line">    &#125; else &#123;</div><div class="line">        return YES;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在webView的回调函数中，通过分析URL，即会调用OC端的flushMessageQueue</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">- (void)flushMessageQueue:(NSString *)messageQueueString&#123;</div><div class="line">    if (messageQueueString == nil || messageQueueString.length == 0) &#123;</div><div class="line">        NSLog(@&quot;WebViewJavascriptBridge: WARNING: ObjC got nil while fetching the message queue JSON from webview. This can happen if the WebViewJavascriptBridge JS is not currently present in the webview, e.g if the webview just loaded a new page.&quot;);</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    id messages = [self _deserializeMessageJSON:messageQueueString];</div><div class="line">    for (WVJBMessage* message in messages) &#123;</div><div class="line">        if (![message isKindOfClass:[WVJBMessage class]]) &#123;</div><div class="line">            NSLog(@&quot;WebViewJavascriptBridge: WARNING: Invalid %@ received: %@&quot;, [message class], message);</div><div class="line">            continue;</div><div class="line">        &#125;</div><div class="line">        [self _log:@&quot;RCVD&quot; json:message];</div><div class="line">         </div><div class="line">        NSString* responseId = message[@&quot;responseId&quot;];</div><div class="line">        if (responseId) &#123; // 如果有responseId，其实就意味着这个消息只是Objective-C之前所发送给JS的消息的回应，触发Objective-C端的回调函数</div><div class="line">            WVJBResponseCallback responseCallback = _responseCallbacks[responseId];</div><div class="line">            responseCallback(message[@&quot;responseData&quot;]);</div><div class="line">            [self.responseCallbacks removeObjectForKey:responseId];</div><div class="line">        &#125; else &#123;//如果没有，说明这个消息是JS的请求</div><div class="line">            WVJBResponseCallback responseCallback = NULL;</div><div class="line">            NSString* callbackId = message[@&quot;callbackId&quot;];</div><div class="line">            if (callbackId) &#123;// 需要回调的话，则会创建一个block，block中的代码会向Javascript发送一个响应类型的消息，附带callbackId（Key为responseId）和响应数据。</div><div class="line">                responseCallback = ^(id responseData) &#123;</div><div class="line">                    if (responseData == nil) &#123;</div><div class="line">                        responseData = [NSNull null];</div><div class="line">                    &#125;</div><div class="line">                     </div><div class="line">                    WVJBMessage* msg = @&#123; @&quot;responseId&quot;:callbackId, @&quot;responseData&quot;:responseData &#125;;//在后文的分析中，会发现在JS端也会有个函数_dispatchMessageFromObjC代码逻辑和flushMessageQueue一样，实际上这个key是responseId就意味着会在回调函数执行的时候，调用JS代码，然后执行_dispatchMessageFromObjC，进入回调函数的分支，调用最早在JS本地保存好的回调函数。</div><div class="line">                    [self _queueMessage:msg];</div><div class="line">                &#125;;</div><div class="line">            &#125; else &#123;//如果不需要的话，回调block为空</div><div class="line">                responseCallback = ^(id ignoreResponseData) &#123;</div><div class="line">                    // Do nothing</div><div class="line">                &#125;;</div><div class="line">            &#125;</div><div class="line">             </div><div class="line">            WVJBHandler handler = self.messageHandlers[message[@&quot;handlerName&quot;]];//JS要调用native的方法名字</div><div class="line">             </div><div class="line">            if (!handler) &#123;</div><div class="line">                NSLog(@&quot;WVJBNoHandlerException, No handler for message from JS: %@&quot;, message);</div><div class="line">                continue;</div><div class="line">            &#125;</div><div class="line">             </div><div class="line">            handler(message[@&quot;data&quot;], responseCallback);//执行相应native方法，并附上之前设定的回调函数</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在回调函数中，会调用[self _queueMessage:msg] 方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">- (void)_queueMessage:(WVJBMessage*)message &#123;</div><div class="line">    if (self.startupMessageQueue) &#123;</div><div class="line">        [self.startupMessageQueue addObject:message];</div><div class="line">    &#125; else &#123;</div><div class="line">        [self _dispatchMessage:message];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">  </div><div class="line">- (void)_dispatchMessage:(WVJBMessage*)message &#123;</div><div class="line">    NSString *messageJSON = [self _serializeMessage:message pretty:NO];</div><div class="line">    [self _log:@&quot;SEND&quot; json:messageJSON];</div><div class="line">    messageJSON = [messageJSON stringByReplacingOccurrencesOfString:@&quot;\\&quot; withString:@&quot;\\\\&quot;];</div><div class="line">    messageJSON = [messageJSON stringByReplacingOccurrencesOfString:@&quot;\&quot;&quot; withString:@&quot;\\\&quot;&quot;];</div><div class="line">    messageJSON = [messageJSON stringByReplacingOccurrencesOfString:@&quot;\&apos;&quot; withString:@&quot;\\\&apos;&quot;];</div><div class="line">    messageJSON = [messageJSON stringByReplacingOccurrencesOfString:@&quot;\n&quot; withString:@&quot;\\n&quot;];</div><div class="line">    messageJSON = [messageJSON stringByReplacingOccurrencesOfString:@&quot;\r&quot; withString:@&quot;\\r&quot;];</div><div class="line">    messageJSON = [messageJSON stringByReplacingOccurrencesOfString:@&quot;\f&quot; withString:@&quot;\\f&quot;];</div><div class="line">    messageJSON = [messageJSON stringByReplacingOccurrencesOfString:@&quot;\u2028&quot; withString:@&quot;\\u2028&quot;];</div><div class="line">    messageJSON = [messageJSON stringByReplacingOccurrencesOfString:@&quot;\u2029&quot; withString:@&quot;\\u2029&quot;];</div><div class="line">     </div><div class="line">    NSString* javascriptCommand = [NSString stringWithFormat:@&quot;WebViewJavascriptBridge._handleMessageFromObjC(&apos;%@&apos;);&quot;, messageJSON];</div><div class="line">    if ([[NSThread currentThread] isMainThread]) &#123;</div><div class="line">        [self _evaluateJavascript:javascriptCommand];</div><div class="line">    &#125; else &#123;</div><div class="line">        dispatch_sync(dispatch_get_main_queue(), ^&#123;</div><div class="line">            [self _evaluateJavascript:javascriptCommand];</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>会调用JS中代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">function _handleMessageFromObjC(messageJSON) &#123;</div><div class="line">    _dispatchMessageFromObjC(messageJSON);</div><div class="line">&#125;</div><div class="line">  </div><div class="line">function _dispatchMessageFromObjC(messageJSON) &#123;</div><div class="line">        setTimeout(function _timeoutDispatchMessageFromObjC() &#123;</div><div class="line">            var message = JSON.parse(messageJSON);</div><div class="line">            var messageHandler;</div><div class="line">            var responseCallback;</div><div class="line">            if (message.responseId) &#123;</div><div class="line">                responseCallback = responseCallbacks[message.responseId];</div><div class="line">                if (!responseCallback) &#123;</div><div class="line">                    return;</div><div class="line">                &#125;</div><div class="line">                responseCallback(message.responseData);</div><div class="line">                delete responseCallbacks[message.responseId];</div><div class="line">            &#125; else &#123;</div><div class="line">                if (message.callbackId) &#123;</div><div class="line">                    var callbackResponseId = message.callbackId;</div><div class="line">                    responseCallback = function(responseData) &#123;</div><div class="line">                        _doSend(&#123; responseId:callbackResponseId, responseData:responseData &#125;);</div><div class="line">                    &#125;;</div><div class="line">                &#125;</div><div class="line">                 </div><div class="line">                var handler = messageHandlers[message.handlerName];</div><div class="line">                try &#123;</div><div class="line">                    handler(message.data, responseCallback);</div><div class="line">                &#125; catch(exception) &#123;</div><div class="line">                    console.log(&quot;WebViewJavascriptBridge: WARNING: javascript handler threw.&quot;, message, exception);</div><div class="line">                &#125;</div><div class="line">                if (!handler) &#123;</div><div class="line">                    console.log(&quot;WebViewJavascriptBridge: WARNING: no handler for message from ObjC:&quot;, message);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>刚才定义了 responseId ，所以就会直接执行刚才存储在 responseCallbacks 中的回调方法。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在最初读代码的时候，我对这个message的responseId和callBackId的这两个参数感到有些混乱。但是仔细分析代码就会发现，在JS的_dispatchMessageFromObjC和native的flushMessageQueue代码逻辑一样，实际做的事也是一样，其实OC调用JS和JS调用OC的逻辑也是一样，二者成对应关系。总之responseId字段是用来判断这个请求是不是本方发送消息给接受方之后发回来的回调消息，callBackId发送方发送请求消息的时候，在发送方那里存放的回调函数的ID,所以需要在接收方发送回调消息的时候，把这个callBackId赋给responseID的key，这样就能进入发送方的处理回调消息的代码了。(这一部分算是对之前的一段总结吧)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/09/17/WebViewJavascriptBridge原理分析/" data-id="cit7barr500009ks6ggteb9um" class="article-share-link">Delen</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/源码分析/">源码分析</a></li></ul>

    </footer>
  </div>
  
    
  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Labels</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/源码分析/">源码分析</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/源码分析/" style="font-size: 10px;">源码分析</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archieven</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recente berichten</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/09/17/WebViewJavascriptBridge原理分析/">WebViewJavascriptBridge原理分析</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 garnetwzy<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>